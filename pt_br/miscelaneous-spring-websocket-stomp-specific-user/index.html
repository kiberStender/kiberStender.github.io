<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://kiberstender.github.io name=base><title>
         Spring Websocket com Stomp- Como enviar dados para um único usuário
        
    </title><meta content="Spring Websocket com Stomp- Como enviar dados para um único usuário" property=og:title><link href=https://kiberstender.github.io/fonts.css rel=stylesheet><link href=https://kiberstender.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://kiberstender.github.io/theme/light.css rel=stylesheet><link href=https://kiberstender.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://kiberstender.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://kiberstender.github.io/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://kiberstender.github.io></a><div class=socials><a class=social href=https://github.com/kiberStender rel=me> <img alt=github src=https://kiberstender.github.io/icons/social/github.svg> </a></div></div><nav><a href=https://kiberstender.github.io/tags style=margin-left:.25em>/tags</a><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://kiberstender.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://kiberstender.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><main><article><div class=title><div class=page-header>Spring Websocket com Stomp- Como enviar dados para um único usuário<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2019-12-15</time> :: 3164 Words <span class=tags-label> :: Tags:</span><span class=tags> <a class=post-tag href=https://kiberstender.github.io/pt_br/tags/spring/>spring</a>, <a class=post-tag href=https://kiberstender.github.io/pt_br/tags/websocket/>websocket</a>, <a class=post-tag href=https://kiberstender.github.io/pt_br/tags/stomp/>stomp</a>, <a class=post-tag href=https://kiberstender.github.io/pt_br/tags/chat/>chat</a>, <a class=post-tag href=https://kiberstender.github.io/pt_br/tags/user-specific/>user-specific</a>, <a class=post-tag href=https://kiberstender.github.io/pt_br/tags/introduction/>introduction</a> </span></div></div><section class=body><h1 id=introducao>Introdução</h1><p>Procurando uma forma de enviar dados para usuários usando Spring WebSocket e controlando quando enviar à todos ou quando enviar a apenas um usuário em específico, me deparei com muitos exemplos usando Spring Security. Spring Security não é algo ruim, completamente o opost, é algo muito útil e necessária em qualquer aplicação, but Spring exige um esforço que neste tipo de tarefa que estou fazendo é desnecessário já que Spring força o usuário a logar para poder gerenciar cada usuário mais facilmente para você. Anos atrás eu fiz a mesma coisa(Uma aplicação usando WebSocket) em uma monografia na faculdade usando<a href=https://www.playframework.com/documentation/2.1.x/Home>Play framework 2.1</a> sem precisar adicionar nenhum tipo de artifício de segurança para controlar o usuário e eu não quis este tipo de configuração por aqui também. Após 2 semanas procurando eu finalmente achei uma <a href=https://www.it-swarm.net/pt/java/enviando-mensagem-para-um-usuario-especifico-no-spring-websocket/1045036791/>thread</a> em um fórum brasileiro ensinando como fazer de um jeito simples usando <a href=http://stomp.github.io/stomp-specification-1.1.html>STOMP</a>. Como essa busca consumira muito de meu tempo e era o único exemplo a funcionar que encontrei, decidi escrever essa postagem colocando um pouco mais de detalhes porque a explicação do fórum apenas cobria o problema que o usuário colocou e não como criar do zero você mesmo. Por isso nesta postagem tentarei ensinar como fazer um simples Webchat using Spring WebSocket com STOMP sem Spring Security.<h2 id=definicao-de-websocket>Definição de WebSocket</h2><p>Um WebSocket é uma conexão entre um usuário e um servidor que somente fecha quando o usuário pede or quando algo acontece ao servidor que o força a desconectar o usuário(seja isto problema de hardware, o usuário ser banido por fazer algo impróprio ou o servidor perder a conexão). Outra coisa, diferente de uma conexão normal HTTP que é mão única, ou seja, você pede algo e o servidor te responde usando a mesma conexão, em um WebSocket a conexão é de mão dupla, logo você tem uma conexão a uma sala cheia de usuários conectados ao mesmo lugar. Logo qualquer pedido que o servidor receba, todos os usuários conectados irão receber a resposta. Então para que serve o WebSocket? Para grandes transmissões de dados como vídeo e áudio, igual o Youtube, facilitando ao enviar pequenas partes do vídeo ao invés de enviar o video todo ao usuário. Em uma conexão normal vocẽ precisa enviar o vídeo todo para o usuário and quanto mais tempo para carregar no navegador ou qualquer aparelho usado, maior a chance the um 'timeout', sem mencionar quão pesado fica para manter a conexão aberta. mais informações <a href=https://javascript.info/websocket>aqui</a>.<h2 id=o-problema-e-a-solucao>O problema ... e a solução</h2><p>Espera ... Eu disse que existe uma 'sala de usuários' connectados ao servidor e qualquer pedido enviado todos os usuários receberão a resposta, então aonde 'controlando quando enviar à todos ou quando enviar a apenas um usuário especifico' entra? Bem... claro, isto é um programa, código de máquina, você pode controlar as conexões. cada conexão é vista como uma sessão pelo WebSocket, então você pode enviar dados específicos para um usuário específico usando STOPM. STOMP faz pelo WebSocket o que o REST fez pelo HTTP. Você especifica uma estrutura de 'urls' e as anexa a alguma classe or função e qualquer um que estiver conectao ao WebSocket pode se 'inscrever' a essas 'urls' e escutar logo outros usuários podem enviar dados a qualquer moment e somente quem estiver ouvindo uma rota especpifica poderá receber este dado.<h1 id=implementacao>Implementação</h1><p>Para começar você precisa estar familiarizado com Java 7(ou mais novo), Spring Boot, WebSoket e STOMP. Muito obrigado o tutorial está terminado, você já sabe tudo o que vocẽ precisa.<p>Brincadeira =D (Parece uns certos sites por aí né bael...), mas sim para completar este tutorial você precisa no mínimo de conhecimento em Java, Spring e Maven ou Gradle(Apesar de eu usar os dois nesta demonstração, não irei explicar como eles funcionam e irei focar mais no Maven), tentarei facilitar explicando coisas de Spring com o máximo de detalhes posiveis, então se você nunca usou Spring não se preocupe, você ainda não saberá nada após esta postagem, digo, não se preocupe você saber o mínimo para configurar um projeto básico<h2 id=vamos-dos-inicio>Vamos dos início</h2><p>Garanta ter Java e Maven( ou Gradle) instalados. Crie uma pasta (ou diretoria se fores de Portugal) (como spring_websocket_specific_user por exemplo)<p>Se estiver usando Maven crie um arquivo (Ou ficheiro amigo português) pom.xml na raíz de sua pasta e copie o seguinte:<pre class=language-xml data-lang=xml style=color:#c0c5ce;background-color:#2b303b><code class=language-xml data-lang=xml><span>&LT?</span><span style=color:#bf616a>xml </span><span style=color:#d08770>version</span><span>="</span><span style=color:#a3be8c>1.0</span><span>" </span><span style=color:#d08770>encoding</span><span>="</span><span style=color:#a3be8c>UTF-8</span><span>"?>
</span><span><</span><span style=color:#bf616a>project </span><span style=color:#d08770>xmlns</span><span>="</span><span style=color:#a3be8c>http://maven.apache.org/POM/4.0.0</span><span>" </span><span style=color:#d08770>xmlns:xsi</span><span>="</span><span style=color:#a3be8c>http://www.w3.org/2001/XMLSchema-instance</span><span>"
</span><span>    </span><span style=color:#d08770>xsi:schemaLocation</span><span>="</span><span style=color:#a3be8c>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd</span><span>">
</span><span>    <</span><span style=color:#bf616a>modelVersion</span><span>>4.0.0&LT/</span><span style=color:#bf616a>modelVersion</span><span>>
</span><span>
</span><span>    <</span><span style=color:#bf616a>groupId</span><span>>org.websocket.spring&LT/</span><span style=color:#bf616a>groupId</span><span>>
</span><span>    <</span><span style=color:#bf616a>artifactId</span><span>>spring_websocket_specific_user&LT/</span><span style=color:#bf616a>artifactId</span><span>>
</span><span>    <</span><span style=color:#bf616a>version</span><span>>0.1.0&LT/</span><span style=color:#bf616a>version</span><span>>
</span><span>
</span><span>    <</span><span style=color:#bf616a>parent</span><span>>
</span><span>        <</span><span style=color:#bf616a>groupId</span><span>>org.springframework.boot&LT/</span><span style=color:#bf616a>groupId</span><span>>
</span><span>        <</span><span style=color:#bf616a>artifactId</span><span>>spring-boot-starter-parent&LT/</span><span style=color:#bf616a>artifactId</span><span>>
</span><span>        <</span><span style=color:#bf616a>version</span><span>>2.2.1.RELEASE&LT/</span><span style=color:#bf616a>version</span><span>>
</span><span>    &LT/</span><span style=color:#bf616a>parent</span><span>>
</span><span>
</span><span>    <</span><span style=color:#bf616a>dependencies</span><span>>
</span><span>        <</span><span style=color:#bf616a>dependency</span><span>>
</span><span>          <</span><span style=color:#bf616a>groupId</span><span>>org.springframework.boot&LT/</span><span style=color:#bf616a>groupId</span><span>>
</span><span>          <</span><span style=color:#bf616a>artifactId</span><span>>spring-boot-starter-websocket&LT/</span><span style=color:#bf616a>artifactId</span><span>>
</span><span>        &LT/</span><span style=color:#bf616a>dependency</span><span>>
</span><span>        <</span><span style=color:#bf616a>dependency</span><span>>
</span><span>            <</span><span style=color:#bf616a>groupId</span><span>>org.springframework.boot&LT/</span><span style=color:#bf616a>groupId</span><span>>
</span><span>            <</span><span style=color:#bf616a>artifactId</span><span>>spring-boot-starter-test&LT/</span><span style=color:#bf616a>artifactId</span><span>>
</span><span>            <</span><span style=color:#bf616a>scope</span><span>>test&LT/</span><span style=color:#bf616a>scope</span><span>>
</span><span>        &LT/</span><span style=color:#bf616a>dependency</span><span>>
</span><span>        <</span><span style=color:#bf616a>dependency</span><span>>
</span><span>            <</span><span style=color:#bf616a>groupId</span><span>>com.jayway.jsonpath&LT/</span><span style=color:#bf616a>groupId</span><span>>
</span><span>            <</span><span style=color:#bf616a>artifactId</span><span>>json-path&LT/</span><span style=color:#bf616a>artifactId</span><span>>
</span><span>            <</span><span style=color:#bf616a>scope</span><span>>test&LT/</span><span style=color:#bf616a>scope</span><span>>
</span><span>        &LT/</span><span style=color:#bf616a>dependency</span><span>>
</span><span>    &LT/</span><span style=color:#bf616a>dependencies</span><span>>
</span><span>
</span><span>    <</span><span style=color:#bf616a>properties</span><span>>
</span><span>        <</span><span style=color:#bf616a>java.version</span><span>>1.8&LT/</span><span style=color:#bf616a>java.version</span><span>>
</span><span>    &LT/</span><span style=color:#bf616a>properties</span><span>>
</span><span>
</span><span>    <</span><span style=color:#bf616a>build</span><span>>
</span><span>        <</span><span style=color:#bf616a>plugins</span><span>>
</span><span>            <</span><span style=color:#bf616a>plugin</span><span>>
</span><span>                <</span><span style=color:#bf616a>groupId</span><span>>org.springframework.boot&LT/</span><span style=color:#bf616a>groupId</span><span>>
</span><span>                <</span><span style=color:#bf616a>artifactId</span><span>>spring-boot-maven-plugin&LT/</span><span style=color:#bf616a>artifactId</span><span>>
</span><span>            &LT/</span><span style=color:#bf616a>plugin</span><span>>
</span><span>        &LT/</span><span style=color:#bf616a>plugins</span><span>>
</span><span>    &LT/</span><span style=color:#bf616a>build</span><span>>
</span><span>&LT/</span><span style=color:#bf616a>project</span><span>>
</span></code></pre><p>Se estiver usando Gradle crie um arquivo build.gradle na raíz de sua pasta e copie o seguinte:<pre class=language-groovy data-lang=groovy style=color:#c0c5ce;background-color:#2b303b><code class=language-groovy data-lang=groovy><span>buildscript {
</span><span>    repositories {
</span><span>        mavenCentral()
</span><span>    }
</span><span>    dependencies {
</span><span>        classpath("</span><span style=color:#a3be8c>org.springframework.boot:spring-boot-gradle-plugin:2.2.1.RELEASE</span><span>")
</span><span>    }
</span><span>}
</span><span>
</span><span>apply </span><span style=color:#d08770>plugin</span><span>: '</span><span style=color:#a3be8c>java</span><span>'
</span><span>apply </span><span style=color:#d08770>plugin</span><span>: '</span><span style=color:#a3be8c>eclipse</span><span>'
</span><span>apply </span><span style=color:#d08770>plugin</span><span>: '</span><span style=color:#a3be8c>idea</span><span>'
</span><span>apply </span><span style=color:#d08770>plugin</span><span>: '</span><span style=color:#a3be8c>org.springframework.boot</span><span>'
</span><span>apply </span><span style=color:#d08770>plugin</span><span>: '</span><span style=color:#a3be8c>io.spring.dependency-management</span><span>'
</span><span>
</span><span>bootJar {
</span><span>    baseName = '</span><span style=color:#a3be8c>spring_websocket_specific_user</span><span>'
</span><span>    version =  '</span><span style=color:#a3be8c>0.1.0</span><span>'
</span><span>}
</span><span>
</span><span>repositories {
</span><span>    mavenCentral()
</span><span>}
</span><span>
</span><span>sourceCompatibility = </span><span style=color:#d08770>1.8
</span><span>targetCompatibility = </span><span style=color:#d08770>1.8
</span><span>
</span><span>dependencies {
</span><span>    compile("</span><span style=color:#a3be8c>org.springframework.boot:spring-boot-starter-websocket</span><span>")
</span><span>    testCompile('</span><span style=color:#a3be8c>org.springframework.boot:spring-boot-starter-test</span><span>')
</span><span>}
</span></code></pre><p>Estes arquivo irão gerencia as dependencias do Spring e baixar para você tudo o que irá precisar para que o Spring funcione. Agora crie 4 pastas uma dentro da outra: src, depois main depoir java e por fim websocket<p>Representação no Maven</p><img src=/imgs/tree_maven.png><p>Representação no Gradle</p><img src=/imgs/tree_gradle.png><h2 id=criando-nossa-classe-main>Criando nossa classe Main</h2><p>Agora vamos criar a classe que irá iniciar nosso programa<p>Vá para /src/main/java/websocket e crie um arquivo de nome Main.java e adicione o seguinte:<pre class=language-java data-lang=java style=color:#c0c5ce;background-color:#2b303b><code class=language-java data-lang=java><span style=color:#b48ead>package </span><span>websocket;
</span><span>
</span><span style=color:#b48ead>import </span><span>org.springframework.boot.</span><span style=color:#ebcb8b>SpringApplication</span><span>;
</span><span style=color:#b48ead>import </span><span>org.springframework.boot.autoconfigure.</span><span style=color:#ebcb8b>SpringBootApplication</span><span>;
</span><span>
</span><span>@</span><span style=color:#bf616a>SpringBootApplication
</span><span style=color:#b48ead>public class </span><span style=color:#ebcb8b>Main </span><span style=color:#eff1f5>{
</span><span style=color:#eff1f5>
</span><span style=color:#eff1f5>  </span><span style=color:#b48ead>public static void </span><span style=color:#8fa1b3>main</span><span style=color:#eff1f5>(</span><span style=color:#ebcb8b>String</span><span style=color:#b48ead>[] </span><span style=color:#bf616a>args</span><span style=color:#eff1f5>) {
</span><span style=color:#eff1f5>    </span><span style=color:#ebcb8b>SpringApplication</span><span style=color:#eff1f5>.</span><span style=color:#bf616a>run</span><span style=color:#eff1f5>(</span><span style=color:#ebcb8b>Main</span><span style=color:#eff1f5>.</span><span style=color:#bf616a>class</span><span style=color:#eff1f5>, args);
</span><span style=color:#eff1f5>  }
</span><span style=color:#eff1f5>}
</span></code></pre><p>Agora você pode rodar e testar se tudo está a funcionar<pre class=language-sh data-lang=sh style=color:#c0c5ce;background-color:#2b303b><code class=language-sh data-lang=sh><span style=color:#bf616a>mvn</span><span> spring-boot:run
</span></code></pre><p>or<pre class=language-sh data-lang=sh style=color:#c0c5ce;background-color:#2b303b><code class=language-sh data-lang=sh><span style=color:#bf616a>gradle</span><span> bootRun
</span></code></pre><p>Se tudo tiver corrido bem você irá ver algo similar a isso:</p><img src=/imgs/spring_success_start.png><h2 id=vamos-criar-nosso-websocket>Vamos criar nosso WebSocket</h2><p>Volte a pasta /src/main/java e crie os pacotes org.websocket.spring.config e org.websocket.spring.controller</p><img src=/imgs/package_creation.png><p>PS: Antes de continuar, garanta que tudo o que fez até agora está correto e que você tem uma aplicação Spring funcionando. Você consegue saber se tudo está bem olhando na foto acima. Não tente fazer os próximos passos se nada está funcionando até este ponto. Caso contrário será difícil saber o que está errado e ficará pior quanto mais você continua.<p>Agora, continuando...<p>Crie um novo arquivo chamado WebSocketConfig.java em /src/main/java/org/websocket/spring/config e adicione o seguinte<pre class=language-java data-lang=java style=color:#c0c5ce;background-color:#2b303b><code class=language-java data-lang=java><span style=color:#b48ead>package </span><span>org.websocket.spring.config;
</span><span>
</span><span style=color:#b48ead>import </span><span>org.springframework.context.annotation.</span><span style=color:#ebcb8b>Configuration</span><span>;
</span><span style=color:#b48ead>import </span><span>org.springframework.messaging.simp.config.</span><span style=color:#ebcb8b>MessageBrokerRegistry</span><span>;
</span><span style=color:#b48ead>import </span><span>org.springframework.web.socket.config.annotation.</span><span style=color:#ebcb8b>EnableWebSocketMessageBroker</span><span>;
</span><span style=color:#b48ead>import </span><span>org.springframework.web.socket.config.annotation.</span><span style=color:#ebcb8b>StompEndpointRegistry</span><span>;
</span><span style=color:#b48ead>import </span><span>org.springframework.web.socket.config.annotation.</span><span style=color:#ebcb8b>WebSocketMessageBrokerConfigurer</span><span>;
</span><span>
</span><span>@</span><span style=color:#bf616a>Configuration
</span><span>@</span><span style=color:#bf616a>EnableWebSocketMessageBroker
</span><span style=color:#b48ead>public class </span><span style=color:#ebcb8b>WebSocketConfig </span><span style=color:#b48ead>implements </span><span style=color:#a3be8c>WebSocketMessageBrokerConfigurer </span><span style=color:#eff1f5>{
</span><span style=color:#eff1f5>
</span><span style=color:#eff1f5>  @</span><span style=color:#bf616a>Override
</span><span style=color:#eff1f5>  </span><span style=color:#b48ead>public void </span><span style=color:#8fa1b3>configureMessageBroker</span><span style=color:#eff1f5>(</span><span style=color:#ebcb8b>MessageBrokerRegistry </span><span style=color:#bf616a>config</span><span style=color:#eff1f5>) {
</span><span style=color:#eff1f5>    config.</span><span style=color:#bf616a>enableSimpleBroker</span><span style=color:#eff1f5>(</span><span>"</span><span style=color:#a3be8c>/user</span><span>"</span><span style=color:#eff1f5>, </span><span>"</span><span style=color:#a3be8c>/topic</span><span>"</span><span style=color:#eff1f5>, </span><span>"</span><span style=color:#a3be8c>/queue</span><span>"</span><span style=color:#eff1f5>);
</span><span style=color:#eff1f5>    config.</span><span style=color:#bf616a>setApplicationDestinationPrefixes</span><span style=color:#eff1f5>(</span><span>"</span><span style=color:#a3be8c>/app</span><span>"</span><span style=color:#eff1f5>);
</span><span style=color:#eff1f5>  }
</span><span style=color:#eff1f5>
</span><span style=color:#eff1f5>  @</span><span style=color:#bf616a>Override
</span><span style=color:#eff1f5>  </span><span style=color:#b48ead>public void </span><span style=color:#8fa1b3>registerStompEndpoints</span><span style=color:#eff1f5>(</span><span style=color:#ebcb8b>StompEndpointRegistry </span><span style=color:#bf616a>registry</span><span style=color:#eff1f5>) {
</span><span style=color:#eff1f5>    registry.</span><span style=color:#bf616a>addEndpoint</span><span style=color:#eff1f5>(</span><span>"</span><span style=color:#a3be8c>/websocket-chat</span><span>"</span><span style=color:#eff1f5>).</span><span style=color:#bf616a>withSockJS</span><span style=color:#eff1f5>();
</span><span style=color:#eff1f5>  }
</span><span style=color:#eff1f5>}
</span></code></pre><h2 id=spring-built-in-support-eu-nao-soube-como-traduzir-isso-perdoem-me>Spring built-in support (Eu não soube como traduzir isso, perdoem-me)</h2><p>STOMP é apenas um protocolo para nos facilitar enviar mensagens ao servidor. Antes do STOMP tínhamos que criar classes de dados cheias e enums para saber o tipo do request, processar no fluxo correto e retornar a resposta adequada poruq eso se tinha um endpoint para o WebSocket. Mas com o STOMP nós podemos criar 'urls internas' para ações semelhantes a applicações de Queue(como Rabbit MQ, Zero MQ, etc), com a diferença de que o RabbitMQ se não houver nenhum cliente conectado e alguma mensagem for enviada ele guarda a mensagem até alguém se conectar e consumir, enquanto que com o STOMP, se não houver ninguém conectado e uma mensagem for enviada essa mensagem jamais será consumida por ninguém. Baseado na url podemos anexar funções (como você faz com Urls REST). Para este propósito Spring tem algo muito legal para a gente, ele pré-define 3 tipos de URL: <code>/topic</code>, <code>/queue</code> e <code>/user</code>.<ul><li>/topic- Ao criar qualquer endpoint que comece com essa raíz (como /topic/newMember ou /topic/disconnectedMember) Spring irá enviar as mensagens a qualquer usuário conectado ao WebSocket<li>/queue- Ao criar qualquer endpoint que comece com essa raíz (como /queue/register ou /queue/unregister) Spring irá enviar as mensagens somente ao usuário que pediu isto como uma conexão HTTP normal. Imagine que você quer se registrar em nosso chat e se você for elegível(tradução feia) você receberá uma lista com os outros usuários conectados mas os outros usuários já tem essa lista, então você não quer que eles recebam nada<li>/user- Ao criar qualque endpoint que comece com essa raíz (como /user/{username}/msg) Spring irá enviar as mensagens somente ao usuário entre chaves(<code>{username}</code>). Observe que quando implementarmos as rotas /user nós não precisaremos do usuário <code>{username}</code>, isso foi apenas para ilustrar meu exemplo.</ul><h2 id=explicacao-do-arquivo-de-configuracao>Explicação do arquivo de Configuração</h2><p>Nós criamos uma classe de configuração Spring com a anotação <code>@Configuration</code> para configurar os endpoints do nosso WebSocket. Para <code>enableSimpleBroker</code> nós colocamos três 'Spring built-in helpers': <code>/user</code>, <code>/queue</code>, <code>/topic</code> porque precisaremos de todos eles. <code>/user</code> para redirecionarmos mensagens específicas do usuário no chat. <code>/queue</code> para registrar e desregistrar(?) nosso usuário e <code>/topic</code> para espalhar a palavra de que algum novo usuário entrou ou saiu da sala.<p>O <code>/app</code> na chamado do método <code>setApplicationDestinationPrefixes</code> é apenas um nome aleatório que você pode dar para segregar as rotas do WebSocket das rotas normais HTTP. Por último mas não menos importante: <code>addEndpoint</code> cirar a url do nosso WebSocket que passamos como parâmetro para conectar em nosso WebSocket no nosso exemplo você precisa usar a seguinte String: <code>ws://localhost:9000/websocket-chat</code>(apenas se você esitver usando uma aplicação de WebSocket de fora de nosso app, porque em nosso cliente interno em Javascript nós usaremos <code>/websocket-chat</code>).<p>Agora vamos criar a classe de dados onde iremos guardar a mensagem, quem a enviou e quem deve recebê-la. Apenas crie uma classe chamada WebSocketMessage e adicione o seguinte(Eu criei esta classe no pacote /src/main/java/org/websocket/spring/controller):<pre class=language-java data-lang=java style=color:#c0c5ce;background-color:#2b303b><code class=language-java data-lang=java><span style=color:#b48ead>package </span><span>org.websocket.spring.controller;
</span><span>
</span><span style=color:#b48ead>public class </span><span style=color:#ebcb8b>WebSocketMessage </span><span style=color:#eff1f5>{
</span><span style=color:#eff1f5>  </span><span style=color:#b48ead>public final </span><span style=color:#ebcb8b>String </span><span style=color:#eff1f5>toWhom;
</span><span style=color:#eff1f5>  </span><span style=color:#b48ead>public final </span><span style=color:#ebcb8b>String </span><span style=color:#eff1f5>fromWho;
</span><span style=color:#eff1f5>  </span><span style=color:#b48ead>public final </span><span style=color:#ebcb8b>String </span><span style=color:#eff1f5>message;
</span><span style=color:#eff1f5>  
</span><span style=color:#eff1f5>  </span><span style=color:#b48ead>public </span><span style=color:#8fa1b3>WebSocketMessage</span><span style=color:#eff1f5>(</span><span style=color:#b48ead>final </span><span style=color:#ebcb8b>String </span><span style=color:#bf616a>toWhom</span><span style=color:#eff1f5>, </span><span style=color:#b48ead>final </span><span style=color:#ebcb8b>String </span><span style=color:#bf616a>fromWho</span><span style=color:#eff1f5>, </span><span style=color:#b48ead>final </span><span style=color:#ebcb8b>String </span><span style=color:#bf616a>message</span><span style=color:#eff1f5>){
</span><span style=color:#eff1f5>    </span><span style=color:#bf616a>this</span><span style=color:#eff1f5>.toWhom  </span><span>=</span><span style=color:#eff1f5> toWhom;
</span><span style=color:#eff1f5>    </span><span style=color:#bf616a>this</span><span style=color:#eff1f5>.fromWho </span><span>=</span><span style=color:#eff1f5> fromWho;
</span><span style=color:#eff1f5>    </span><span style=color:#bf616a>this</span><span style=color:#eff1f5>.message </span><span>=</span><span style=color:#eff1f5> message;
</span><span style=color:#eff1f5>  }
</span><span style=color:#eff1f5>}
</span></code></pre><p>Não há muito o que ser explicado aqui (Imagino eu), em uma situação do Mundo Real vocẽ iria criar o báscio hashCode, equals e toString, até mesmo getters e setter, eu prefiro a imutabilidade, mas isso é apenas um exemplo então não vamos nos atentar muito aos detalhes. Então vamos criar nosso Spring Controller. Apenas vá até /src/main/java/org/websocket/spring/controller novamente e crie o arquivo WebSocketController.java e adicione o seguinte:<pre class=language-java data-lang=java style=color:#c0c5ce;background-color:#2b303b><code class=language-java data-lang=java><span style=color:#b48ead>package </span><span>org.websocket.spring.controller;
</span><span>
</span><span style=color:#b48ead>import </span><span>java.util.</span><span style=color:#ebcb8b>Set</span><span>;
</span><span style=color:#b48ead>import </span><span>java.util.</span><span style=color:#ebcb8b>HashSet</span><span>;
</span><span style=color:#b48ead>import </span><span>org.springframework.messaging.handler.annotation.</span><span style=color:#ebcb8b>MessageMapping</span><span>;
</span><span style=color:#b48ead>import </span><span>org.springframework.messaging.handler.annotation.</span><span style=color:#ebcb8b>SendTo</span><span>;
</span><span style=color:#b48ead>import </span><span>org.springframework.messaging.simp.annotation.</span><span style=color:#ebcb8b>SendToUser</span><span>;
</span><span style=color:#b48ead>import </span><span>org.springframework.messaging.simp.</span><span style=color:#ebcb8b>SimpMessagingTemplate</span><span>;
</span><span style=color:#b48ead>import </span><span>org.springframework.stereotype.</span><span style=color:#ebcb8b>Controller</span><span>;
</span><span>
</span><span>@</span><span style=color:#bf616a>Controller
</span><span style=color:#b48ead>public class </span><span style=color:#ebcb8b>WebSocketController </span><span style=color:#eff1f5>{
</span><span style=color:#eff1f5>  </span><span style=color:#b48ead>private final </span><span style=color:#ebcb8b>SimpMessagingTemplate </span><span style=color:#eff1f5>simpMessagingTemplate;   </span><span style=color:#65737e>//1
</span><span style=color:#eff1f5>  </span><span style=color:#b48ead>private final </span><span style=color:#ebcb8b>Set</span><span style=color:#eff1f5><</span><span style=color:#ebcb8b>String</span><span style=color:#eff1f5>> connectedUsers;     </span><span style=color:#65737e>//2
</span><span style=color:#eff1f5>  
</span><span style=color:#eff1f5>  </span><span style=color:#b48ead>public </span><span style=color:#8fa1b3>WebSocketController</span><span style=color:#eff1f5>(</span><span style=color:#ebcb8b>SimpMessagingTemplate </span><span style=color:#bf616a>simpMessagingTemplate</span><span style=color:#eff1f5>){ 
</span><span style=color:#eff1f5>    </span><span style=color:#bf616a>this</span><span style=color:#eff1f5>.simpMessagingTemplate </span><span>=</span><span style=color:#eff1f5> simpMessagingTemplate; </span><span style=color:#65737e>//1
</span><span style=color:#eff1f5>    connectedUsers </span><span>= </span><span style=color:#b48ead>new </span><span style=color:#ebcb8b>HashSet</span><span style=color:#eff1f5><>();  </span><span style=color:#65737e>//2
</span><span style=color:#eff1f5>  }
</span><span style=color:#eff1f5>  
</span><span style=color:#eff1f5>  @</span><span style=color:#bf616a>MessageMapping</span><span style=color:#eff1f5>(</span><span>"</span><span style=color:#a3be8c>/register</span><span>"</span><span style=color:#eff1f5>)  </span><span style=color:#65737e>//3
</span><span style=color:#eff1f5>  @</span><span style=color:#bf616a>SendToUser</span><span style=color:#eff1f5>(</span><span>"</span><span style=color:#a3be8c>/queue/newMember</span><span>"</span><span style=color:#eff1f5>)
</span><span style=color:#eff1f5>  </span><span style=color:#b48ead>public </span><span style=color:#ebcb8b>Set</span><span style=color:#eff1f5><</span><span style=color:#ebcb8b>String</span><span style=color:#eff1f5>> </span><span style=color:#8fa1b3>registerUser</span><span style=color:#eff1f5>(</span><span style=color:#ebcb8b>String </span><span style=color:#bf616a>webChatUsername</span><span style=color:#eff1f5>){
</span><span style=color:#eff1f5>    </span><span style=color:#b48ead>if</span><span style=color:#eff1f5>(</span><span>!</span><span style=color:#eff1f5>connectedUsers.</span><span style=color:#bf616a>contains</span><span style=color:#eff1f5>(webChatUsername)) {
</span><span style=color:#eff1f5>      connectedUsers.</span><span style=color:#bf616a>add</span><span style=color:#eff1f5>(webChatUsername);
</span><span style=color:#eff1f5>      simpMessagingTemplate.</span><span style=color:#bf616a>convertAndSend</span><span style=color:#eff1f5>(</span><span>"</span><span style=color:#a3be8c>/topic/newMember</span><span>"</span><span style=color:#eff1f5>, webChatUsername); </span><span style=color:#65737e>//4
</span><span style=color:#eff1f5>      </span><span style=color:#b48ead>return</span><span style=color:#eff1f5> connectedUsers;
</span><span style=color:#eff1f5>    } </span><span style=color:#b48ead>else </span><span style=color:#eff1f5>{
</span><span style=color:#eff1f5>      </span><span style=color:#b48ead>return new </span><span style=color:#ebcb8b>HashSet</span><span style=color:#eff1f5><>();
</span><span style=color:#eff1f5>    }
</span><span style=color:#eff1f5>  }
</span><span style=color:#eff1f5>  
</span><span style=color:#eff1f5>  @</span><span style=color:#bf616a>MessageMapping</span><span style=color:#eff1f5>(</span><span>"</span><span style=color:#a3be8c>/unregister</span><span>"</span><span style=color:#eff1f5>)  </span><span style=color:#65737e>//5
</span><span style=color:#eff1f5>  @</span><span style=color:#bf616a>SendTo</span><span style=color:#eff1f5>(</span><span>"</span><span style=color:#a3be8c>/topic/disconnectedUser</span><span>"</span><span style=color:#eff1f5>)
</span><span style=color:#eff1f5>  </span><span style=color:#b48ead>public </span><span style=color:#ebcb8b>String </span><span style=color:#8fa1b3>unregisterUser</span><span style=color:#eff1f5>(</span><span style=color:#ebcb8b>String </span><span style=color:#bf616a>webChatUsername</span><span style=color:#eff1f5>){
</span><span style=color:#eff1f5>    connectedUsers.</span><span style=color:#bf616a>remove</span><span style=color:#eff1f5>(webChatUsername);
</span><span style=color:#eff1f5>    </span><span style=color:#b48ead>return</span><span style=color:#eff1f5> webChatUsername;
</span><span style=color:#eff1f5>  }
</span><span style=color:#eff1f5>
</span><span style=color:#eff1f5>  @</span><span style=color:#bf616a>MessageMapping</span><span style=color:#eff1f5>(</span><span>"</span><span style=color:#a3be8c>/message</span><span>"</span><span style=color:#eff1f5>)  </span><span style=color:#65737e>//6
</span><span style=color:#eff1f5>  </span><span style=color:#b48ead>public void </span><span style=color:#8fa1b3>greeting</span><span style=color:#eff1f5>(</span><span style=color:#ebcb8b>WebSocketMessage </span><span style=color:#bf616a>message</span><span style=color:#eff1f5>){
</span><span style=color:#eff1f5>    simpMessagingTemplate.</span><span style=color:#bf616a>convertAndSendToUser</span><span style=color:#eff1f5>(message.toWhom, </span><span>"</span><span style=color:#a3be8c>/msg</span><span>"</span><span style=color:#eff1f5>, message);
</span><span style=color:#eff1f5>  }
</span><span style=color:#eff1f5>}
</span></code></pre><p>Eu coloquei comentário listando os pontos interessantes aqui:<ol><li>Começando pela versão 4( Eu acho) Spring não precisa mais <code>@Autowired</code> para injetar objetos se você os inicializar no construtor. Isso facilita muito criar componentes imutáveis ou pelo menos diminuir a mutabilidade das variáveis, então o que eu fiz foi injetar um objeto do tipo <code>SimpMessagingTemplate</code>. Este objeto irá nos ajudar a redirecionar nossas mensagens para o usuário correto.<li>Para mostrar aos outros usuários quem está conectado no momento para que você não precise adivinhar o nome do usário que você quer enviar uma mensagem, eu criei um Set de Strings que irá guardar os nomes dos usuários conectados.<li>Eu criei esta rota para registrar nosso usuário quando ele se conecta ao nosso WebSocket. Você verá na parte em Javascript que isto não ocorre automaticamente, vocẽ precisa enviar uma mensagem para a url <code>/app/register</code> logo após se conectar. A anotação <code>@SendToUser("/queue/newMember")</code> é o endpoint que nosso usuário irá se inscrever (ou escutar) para quando ele/ela se registrarem em nosso WebSocket a resposta(seja o que a função retornar, neste caso um Set the usuários conectados) irá ser enviada somente a ele/ela, porque se você observar, este é um endpoint <code>/queue</code>.<li>Eu apenas checo se o usuário já existe em nossa 'Base de dados' e caso sim retorno um Set vazio(você irá entender por que na parte em JS). Caso contrário eu chamo <code>simpMessagingTemplate.convertAndSend("/topic/newMember", webChatUsername);</code> para avisar os outros usuparios que alguém acabou de entrar na sla e por fim retorno a lista com os usuários conectados para o novo usuário conectado. Observe que nós apenas enviamos a messagem para o endpoint <code>/topic</code> , então todos irão recebê- la.<li>Aqui é o oposto do que a função anterior faz. Um usuário decidiu se desconectar, então o/a removemos de nossa 'Base de dados' e retornamos seu nome para o endpoint <code>/topic</code> para que o resto dos usuários saibam que ele/ela saiu. Veja que aqui ao invés de usar o objeto <code>simp</code> eu usei a anotação <code>SendTo</code>, ela tem o mesmo efeito que a função <code>convertAndSend</code> na classe <code>SimpMessagingTemplate</code>. A diferença está no fato que aqui temos a vantagem do compilador, porque nós dizemos o que queremos enviar ao endpoint na assinatura da função, enquanto que a função <code>convertAndSend</code> recebe como parâmetro um Object. Eu usei o formato diferente na função anterior por que não se pode enviar dados a dois endpoints usando um único retorno de função, então retornei ao <code>/queue</code>usando o mecanismo de retorno da linguagem e usei o método <code>convertAndSend</code> para o endpoint <code>/topic</code>.<li>E aqui é onde a mágica acontence. Aqui recebemos a mensagem do usuário usando nossa classe <code>WebSocketMessage</code> e extraímos para quem esta mensagem deve ser entregue. Em teoria a anotação <code>@SendToUser</code> poderia fazer esse truque para nós e redirecionar a mensagem para o recipiente correto mas para conseguir isso eu aprendi em todas as minhas pesquisas que você precisa configurar Spring Security, assim o framework loga o usário e cria uma instancia de Principal para cada usuário logado e usa este objeto para redirecionar as mensagens para o usuário correto. Eu posso estar errado mas todas vezes que tentei sem Spring Security nenhuma funcionou. Então o que aquela postagem no fórum brasileiro que mencionei no início diz para fazer é ignorar esta anotação e usar o método <code>convertAndSendToUser</code> da classe <code>SimpMessagingTemplate</code> e como você verá se seguir o tutorial completo, isso funciona.</ol><p>Agora temos de dizer ao Spring que nossas classes são componentes Spring e assim Spring deve instanciá-las para nós, então devemos modificar noss classe main um pouco para adicionar o escaneador de componentes do Spring e dizer quais pacotes que o Spring deve escanear e fazer sua mágica. Então adicione <code>@ComponentScan({"org.websocket.spring"})</code> em nossa classe <code>Main</code>:<pre class=language-java data-lang=java style=color:#c0c5ce;background-color:#2b303b><code class=language-java data-lang=java><span>...
</span><span style=color:#b48ead>import </span><span>org.springframework.context.annotation.</span><span style=color:#ebcb8b>ComponentScan</span><span>;
</span><span>
</span><span>@</span><span style=color:#bf616a>SpringBootApplication
</span><span>@</span><span style=color:#bf616a>ComponentScan</span><span>({"</span><span style=color:#a3be8c>org.websocket.spring</span><span>"})
</span><span style=color:#b48ead>public class </span><span style=color:#ebcb8b>Main </span><span style=color:#eff1f5>{
</span><span style=color:#eff1f5>...
</span></code></pre><p>Pronto, agora Spring irá instanciar nosso @Controller automaticamente fazendo nosso backend do WebSocket completo. Super simples não? Bem nós poderíamos terminar aqui, mas eu irei fazer um frontend simples para deixar isso ainda mais completo.<h1 id=frontend>Frontend</h1><p>Para o frontend eu irei ser ainda mais simples do que fui no backend. Não irei usar nenhum tipo de framework(React.js, Angular, jQuery, nada), apenas duas bibliotecas: SockJs-client e stomp-webscoket. O resto será puro javascript. SocksJs e Stomp-Websocket nos darão um jeito fácil de controlar nosso cliente WebSocket e o último adiciona STOMP, assim não precisamos manualmente fazer nada quando conectarmos ao nosso servidor de WebSocket. Para adicionar SockJs e Stomp-Websocket irei usar Webjars ao invés de baixar manualmente os arquivos js e colocá-los na nossa pasta resources. Então apenas adicione as duas dependências em nosso build file:<p>Maven<pre class=language-xml data-lang=xml style=color:#c0c5ce;background-color:#2b303b><code class=language-xml data-lang=xml><span><</span><span style=color:#bf616a>dependency</span><span>>
</span><span>  <</span><span style=color:#bf616a>groupId</span><span>>org.webjars&LT/</span><span style=color:#bf616a>groupId</span><span>>
</span><span>  <</span><span style=color:#bf616a>artifactId</span><span>>webjars-locator-core&LT/</span><span style=color:#bf616a>artifactId</span><span>>
</span><span>&LT/</span><span style=color:#bf616a>dependency</span><span>>
</span><span><</span><span style=color:#bf616a>dependency</span><span>>
</span><span>  <</span><span style=color:#bf616a>groupId</span><span>>org.webjars&LT/</span><span style=color:#bf616a>groupId</span><span>>
</span><span>  <</span><span style=color:#bf616a>artifactId</span><span>>sockjs-client&LT/</span><span style=color:#bf616a>artifactId</span><span>>
</span><span>  <</span><span style=color:#bf616a>version</span><span>>1.0.2&LT/</span><span style=color:#bf616a>version</span><span>>
</span><span>&LT/</span><span style=color:#bf616a>dependency</span><span>>
</span><span><</span><span style=color:#bf616a>dependency</span><span>>
</span><span>  <</span><span style=color:#bf616a>groupId</span><span>>org.webjars&LT/</span><span style=color:#bf616a>groupId</span><span>>
</span><span>  <</span><span style=color:#bf616a>artifactId</span><span>>stomp-websocket&LT/</span><span style=color:#bf616a>artifactId</span><span>>
</span><span>  <</span><span style=color:#bf616a>version</span><span>>2.3.3&LT/</span><span style=color:#bf616a>version</span><span>>
</span><span>&LT/</span><span style=color:#bf616a>dependency</span><span>>
</span></code></pre><p>Gradle<pre class=language-groovy data-lang=groovy style=color:#c0c5ce;background-color:#2b303b><code class=language-groovy data-lang=groovy><span>compile("</span><span style=color:#a3be8c>org.webjars:webjars-locator-core</span><span>")
</span><span>compile("</span><span style=color:#a3be8c>org.webjars:sockjs-client:1.0.2</span><span>")
</span><span>compile("</span><span style=color:#a3be8c>org.webjars:stomp-websocket:2.3.3</span><span>")
</span></code></pre><p>Se você nunca usou ou ouviu falar de Webjar, isto é apenas uma biblioteca javascript empacotada em um pacote Java jar, assim você pode gerenciá-los como dependências normais via maven, gradle ou qualquer outro. Quando adicionar as bibliotecas vocẽ ainda terá que adicioná- las do jeito antigo no HTML:<pre class=language-html data-lang=html style=color:#c0c5ce;background-color:#2b303b><code class=language-html data-lang=html><span>....
</span><span><</span><span style=color:#bf616a>script </span><span style=color:#d08770>src</span><span>="</span><span style=color:#a3be8c>/webjar/sockjs-client/1.0.2/sock.min.js</span><span>"/>
</span><span>....
</span></code></pre><p>Como é irritante ter que trocar a versão da biblioteca no seu HTML toda vez que você mudar a versão no pom.xml eu adicionei a Webjar <code>locator-core</code>, ela nos ajuda a remover a verbosidade de adicionar versões cada vez que atualizamos a biblioteca. Mude seu HTML para o seguinte e não precisará mudar nunca mais:<pre class=language-html data-lang=html style=color:#c0c5ce;background-color:#2b303b><code class=language-html data-lang=html><span>....
</span><span><</span><span style=color:#bf616a>script </span><span style=color:#d08770>src</span><span>="</span><span style=color:#a3be8c>/webjar/sockjs-client/sock.min.js</span><span>"/>
</span><span>....
</span></code></pre><p>Webjar não funciona apenas como Javascript mas com CSS também. Vou adicionar Bootstrap CSS não para deixar bonito mas para deixar mais alinhado e entendível. Entçao adicione mais uma dependência no seu build file:<p>Maven<pre class=language-xml data-lang=xml style=color:#c0c5ce;background-color:#2b303b><code class=language-xml data-lang=xml><span><</span><span style=color:#bf616a>dependency</span><span>>
</span><span>  <</span><span style=color:#bf616a>groupId</span><span>>org.webjars&LT/</span><span style=color:#bf616a>groupId</span><span>>
</span><span>  <</span><span style=color:#bf616a>artifactId</span><span>>bootstrap&LT/</span><span style=color:#bf616a>artifactId</span><span>>
</span><span>  <</span><span style=color:#bf616a>version</span><span>>3.3.7&LT/</span><span style=color:#bf616a>version</span><span>>
</span><span>&LT/</span><span style=color:#bf616a>dependency</span><span>>
</span></code></pre><p>Gradle<pre class=language-groovy data-lang=groovy style=color:#c0c5ce;background-color:#2b303b><code class=language-groovy data-lang=groovy><span>compile("</span><span style=color:#a3be8c>org.webjars:bootstrap:3.3.7</span><span>")
</span></code></pre><p>Irei criar somente o básico para enviar e receber mensagens e não irei explicar síntaxe de javascript ou detalhes de HTML. A única explicação que você terá nesta seção é quais objetos você deve instaciar, quais métodos usar e porque estamos usando estes assim você pode facilmente fazer modificações para se adequar a sua realidade. Então vamos criar nosso index.html dentro da pasta /src/main/resources/static e adicionar o seguinte:<pre class=language-html data-lang=html style=color:#c0c5ce;background-color:#2b303b><code class=language-html data-lang=html><span><</span><span style=color:#bf616a>html</span><span>>
</span><span>  <</span><span style=color:#bf616a>head</span><span>>
</span><span>    <</span><span style=color:#bf616a>meta </span><span style=color:#d08770>name</span><span>="</span><span style=color:#a3be8c>viewport</span><span>" </span><span style=color:#d08770>content</span><span>="</span><span style=color:#a3be8c>width=device-width, initial-scale=1</span><span>">
</span><span>    <</span><span style=color:#bf616a>title</span><span>>Webchat WebSocket&LT/</span><span style=color:#bf616a>title</span><span>>
</span><span>    <</span><span style=color:#bf616a>link </span><span style=color:#d08770>href</span><span>="</span><span style=color:#a3be8c>/webjars/bootstrap/css/bootstrap.min.css</span><span>" </span><span style=color:#d08770>rel</span><span>="</span><span style=color:#a3be8c>stylesheet</span><span>">
</span><span>  &LT/</span><span style=color:#bf616a>head</span><span>>
</span><span>  <</span><span style=color:#bf616a>body</span><span>>
</span><span>  
</span><span>    <</span><span style=color:#bf616a>div </span><span style=color:#8fa1b3>id</span><span>="</span><span style=color:#a3be8c>main-content</span><span>" </span><span style=color:#d08770>class</span><span>="</span><span style=color:#a3be8c>container</span><span>">
</span><span>      <</span><span style=color:#bf616a>div </span><span style=color:#d08770>class</span><span>="</span><span style=color:#a3be8c>row text-center</span><span>">
</span><span>        <</span><span style=color:#bf616a>h2</span><span>>WebChat WebSocket&LT/</span><span style=color:#bf616a>h2</span><span>>
</span><span>      &LT/</span><span style=color:#bf616a>div</span><span>>
</span><span>
</span><span>      <</span><span style=color:#bf616a>br</span><span>/>
</span><span>
</span><span>      <</span><span style=color:#bf616a>div </span><span style=color:#d08770>class</span><span>="</span><span style=color:#a3be8c>row text-center</span><span>">
</span><span>        <</span><span style=color:#bf616a>div </span><span style=color:#d08770>class</span><span>="</span><span style=color:#a3be8c>col-md-4</span><span>">
</span><span>          <</span><span style=color:#bf616a>label </span><span style=color:#d08770>for</span><span>="</span><span style=color:#a3be8c>webchat_username</span><span>">Username:&LT/</span><span style=color:#bf616a>label</span><span>>
</span><span>          <</span><span style=color:#bf616a>input </span><span style=color:#d08770>type</span><span>="</span><span style=color:#a3be8c>text</span><span>" </span><span style=color:#8fa1b3>id</span><span>="</span><span style=color:#a3be8c>webchat_username</span><span>" </span><span style=color:#d08770>placeholder</span><span>="</span><span style=color:#a3be8c>Put your username here...</span><span>"/>
</span><span>        &LT/</span><span style=color:#bf616a>div</span><span>>
</span><span>        <</span><span style=color:#bf616a>div </span><span style=color:#d08770>class</span><span>="</span><span style=color:#a3be8c>col-md-1</span><span>">
</span><span>          <</span><span style=color:#bf616a>input </span><span style=color:#d08770>type</span><span>="</span><span style=color:#a3be8c>button</span><span>" </span><span style=color:#d08770>class</span><span>="</span><span style=color:#a3be8c>btn</span><span>" </span><span style=color:#8fa1b3>id</span><span>="</span><span style=color:#a3be8c>webchat_connect</span><span>" </span><span style=color:#d08770>value</span><span>="</span><span style=color:#a3be8c>Connect</span><span>"/>
</span><span>        &LT/</span><span style=color:#bf616a>div</span><span>>
</span><span>        <</span><span style=color:#bf616a>div </span><span style=color:#d08770>class</span><span>="</span><span style=color:#a3be8c>col-md-1</span><span>">
</span><span>          <</span><span style=color:#bf616a>input </span><span style=color:#d08770>type</span><span>="</span><span style=color:#a3be8c>button</span><span>" </span><span style=color:#d08770>class</span><span>="</span><span style=color:#a3be8c>btn</span><span>" </span><span style=color:#8fa1b3>id</span><span>="</span><span style=color:#a3be8c>webchat_disconnect</span><span>" </span><span style=color:#d08770>value</span><span>="</span><span style=color:#a3be8c>Disconnect</span><span>" </span><span style=color:#d08770>disabled</span><span>="</span><span style=color:#a3be8c>true</span><span>"/>
</span><span>        &LT/</span><span style=color:#bf616a>div</span><span>>
</span><span>      &LT/</span><span style=color:#bf616a>div</span><span>>
</span><span>
</span><span>      <</span><span style=color:#bf616a>div </span><span style=color:#d08770>class</span><span>="</span><span style=color:#a3be8c>row</span><span>">
</span><span>        <</span><span style=color:#bf616a>div </span><span style=color:#d08770>class</span><span>="</span><span style=color:#a3be8c>row text-center</span><span>"><</span><span style=color:#bf616a>h2</span><span>>Connected Users List&LT/</span><span style=color:#bf616a>h2</span><span>>&LT/</span><span style=color:#bf616a>div</span><span>>
</span><span>        <</span><span style=color:#bf616a>div </span><span style=color:#8fa1b3>id</span><span>="</span><span style=color:#a3be8c>chat_user_list</span><span>" </span><span style=color:#d08770>class</span><span>="</span><span style=color:#a3be8c>row</span><span>">&LT/</span><span style=color:#bf616a>div</span><span>>
</span><span>      &LT/</span><span style=color:#bf616a>div</span><span>>
</span><span>    
</span><span>      <</span><span style=color:#bf616a>div </span><span style=color:#8fa1b3>id</span><span>="</span><span style=color:#a3be8c>chat_list</span><span>" </span><span style=color:#d08770>class</span><span>="</span><span style=color:#a3be8c>row</span><span>">&LT/</span><span style=color:#bf616a>div</span><span>>
</span><span>      
</span><span>      <</span><span style=color:#bf616a>div </span><span style=color:#8fa1b3>id</span><span>="</span><span style=color:#a3be8c>alerts</span><span>">&LT/</span><span style=color:#bf616a>div</span><span>>
</span><span>    &LT/</span><span style=color:#bf616a>div</span><span>>
</span><span>    
</span><span>    <</span><span style=color:#bf616a>script </span><span style=color:#d08770>src</span><span>="</span><span style=color:#a3be8c>/webjars/sockjs-client/sockjs.min.js</span><span>">&LT/</span><span style=color:#bf616a>script</span><span>>
</span><span>    <</span><span style=color:#bf616a>script </span><span style=color:#d08770>src</span><span>="</span><span style=color:#a3be8c>/webjars/stomp-websocket/stomp.min.js</span><span>">&LT/</span><span style=color:#bf616a>script</span><span>>
</span><span>    <</span><span style=color:#bf616a>script </span><span style=color:#d08770>src</span><span>="</span><span style=color:#a3be8c>/js/index.js</span><span>">&LT/</span><span style=color:#bf616a>script</span><span>>
</span><span>  &LT/</span><span style=color:#bf616a>body</span><span>>
</span><span>&LT/</span><span style=color:#bf616a>html</span><span>>
</span></code></pre><p>Agora vamos criar nosso arquivo Javascript dentro de index.js /src/main/resources/static/js e adicionar o seguinte:<pre class=language-javascript data-lang=javascript style=color:#c0c5ce;background-color:#2b303b><code class=language-javascript data-lang=javascript><span>(</span><span style=color:#b48ead>function</span><span>(){
</span><span>  </span><span style=color:#b48ead>function </span><span style=color:#8fa1b3>select</span><span>(</span><span style=color:#bf616a>str</span><span>){
</span><span>    </span><span style=color:#b48ead>return </span><span>document.</span><span style=color:#96b5b4>querySelector</span><span>(</span><span style=color:#bf616a>str</span><span>);
</span><span>  }
</span><span>  
</span><span>  </span><span style=color:#b48ead>function </span><span style=color:#8fa1b3>alertMessage</span><span>(</span><span style=color:#bf616a>message</span><span>, </span><span style=color:#bf616a>type</span><span>){
</span><span>    </span><span style=color:#b48ead>let </span><span style=color:#bf616a>alerts </span><span>= </span><span style=color:#8fa1b3>select</span><span>("</span><span style=color:#a3be8c>#alerts</span><span>");
</span><span>
</span><span>    </span><span style=color:#b48ead>let </span><span style=color:#bf616a>el </span><span>= document.</span><span style=color:#96b5b4>createElement</span><span>("</span><span style=color:#a3be8c>p</span><span>")
</span><span>    </span><span style=color:#bf616a>el</span><span>.</span><span style=color:#bf616a>innerHTML </span><span>= </span><span style=color:#bf616a>message
</span><span>    </span><span style=color:#bf616a>el</span><span>.</span><span style=color:#bf616a>classList</span><span>.</span><span style=color:#96b5b4>add</span><span>(</span><span style=color:#bf616a>type</span><span>)
</span><span>    </span><span style=color:#bf616a>alerts</span><span>.</span><span style=color:#96b5b4>append</span><span>(</span><span style=color:#bf616a>el</span><span>)
</span><span>    </span><span style=color:#96b5b4>setTimeout</span><span>(() </span><span style=color:#b48ead>=> </span><span style=color:#bf616a>alerts</span><span>.</span><span style=color:#bf616a>innerHTML </span><span>= '', </span><span style=color:#d08770>5000</span><span>)
</span><span>  }
</span><span>  
</span><span>  </span><span style=color:#b48ead>function </span><span style=color:#8fa1b3>drawChat</span><span>(</span><span style=color:#bf616a>chatUsername</span><span>){
</span><span>    </span><span style=color:#b48ead>return </span><span>`</span><span style=color:#a3be8c>&LTdiv class="row text-center"></span><span style=color:#96b5b4>\n</span><span style=color:#a3be8c>  &LTh3>Chat with ${</span><span style=color:#bf616a>chatUsername</span><span style=color:#a3be8c>}&LT/h3></span><span style=color:#96b5b4>\n</span><span style=color:#a3be8c>&LT/div></span><span style=color:#96b5b4>\n</span><span style=color:#a3be8c>&LTdiv id="chat_messages_${</span><span style=color:#bf616a>chatUsername</span><span style=color:#a3be8c>}" class="row">&LT/div></span><span style=color:#96b5b4>\n</span><span style=color:#a3be8c>&LTbr/></span><span style=color:#96b5b4>\n</span><span style=color:#a3be8c>&LTdiv class="row"></span><span style=color:#96b5b4>\n</span><span style=color:#a3be8c>  &LTdiv class="col-md-4">&LTtextarea id="chat_input_${</span><span style=color:#bf616a>chatUsername</span><span style=color:#a3be8c>}">&LT/textarea>&LT/div></span><span style=color:#96b5b4>\n</span><span style=color:#a3be8c>  &LTdiv class="col-md-1">&LTinput type="button" id="chat_send_to_${</span><span style=color:#bf616a>chatUsername</span><span style=color:#a3be8c>}" value="Send"/>&LT/div></span><span style=color:#96b5b4>\n</span><span style=color:#a3be8c>&LT/div></span><span>`
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#b48ead>function </span><span style=color:#8fa1b3>getChat</span><span>(</span><span style=color:#bf616a>chatList</span><span>, </span><span style=color:#bf616a>chatName</span><span>){
</span><span>    </span><span style=color:#b48ead>let </span><span style=color:#bf616a>chatRoom </span><span>= </span><span style=color:#bf616a>chatList</span><span>.</span><span style=color:#96b5b4>querySelector</span><span>(`</span><span style=color:#a3be8c>#chat_${</span><span style=color:#bf616a>chatName</span><span style=color:#a3be8c>}</span><span>`)
</span><span>    </span><span style=color:#b48ead>if</span><span>(</span><span style=color:#bf616a>chatRoom </span><span>=== </span><span style=color:#d08770>null</span><span>){
</span><span>      </span><span style=color:#b48ead>let </span><span style=color:#bf616a>el </span><span>= document.</span><span style=color:#96b5b4>createElement</span><span>("</span><span style=color:#a3be8c>div</span><span>")
</span><span>      </span><span style=color:#bf616a>el</span><span>.id = `</span><span style=color:#a3be8c>chat_${</span><span style=color:#bf616a>chatName</span><span style=color:#a3be8c>}</span><span>`
</span><span>      </span><span style=color:#bf616a>el</span><span>.</span><span style=color:#bf616a>innerHTML </span><span>= </span><span style=color:#8fa1b3>drawChat</span><span>(</span><span style=color:#bf616a>chatName</span><span>)
</span><span>      </span><span style=color:#bf616a>el</span><span>.</span><span style=color:#bf616a>classList</span><span>.</span><span style=color:#96b5b4>add</span><span>('</span><span style=color:#a3be8c>row</span><span>')
</span><span>      </span><span style=color:#bf616a>chatList</span><span>.</span><span style=color:#96b5b4>append</span><span>(</span><span style=color:#bf616a>el</span><span>)
</span><span>      </span><span style=color:#b48ead>return </span><span style=color:#bf616a>el</span><span>;
</span><span>    } </span><span style=color:#b48ead>else </span><span>{
</span><span>      </span><span style=color:#b48ead>return </span><span style=color:#bf616a>chatRoom
</span><span>    }
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#b48ead>function </span><span style=color:#8fa1b3>clickSendButton</span><span>(</span><span style=color:#bf616a>chatRoom</span><span>, </span><span style=color:#bf616a>toWhom</span><span>, </span><span style=color:#bf616a>stompClient</span><span>, </span><span style=color:#bf616a>username</span><span>) {
</span><span>    </span><span style=color:#bf616a>chatRoom</span><span>.</span><span style=color:#96b5b4>querySelector</span><span>(`</span><span style=color:#a3be8c>#chat_send_to_${</span><span style=color:#bf616a>toWhom</span><span style=color:#a3be8c>}</span><span>`).</span><span style=color:#96b5b4>addEventListener</span><span>('</span><span style=color:#a3be8c>click</span><span>', () </span><span style=color:#b48ead>=> </span><span>{
</span><span>      </span><span style=color:#b48ead>let </span><span style=color:#bf616a>msgInput </span><span>= </span><span style=color:#bf616a>chatRoom</span><span>.</span><span style=color:#96b5b4>querySelector</span><span>(`</span><span style=color:#a3be8c>#chat_input_${</span><span style=color:#bf616a>toWhom</span><span style=color:#a3be8c>}</span><span>`)
</span><span>      </span><span style=color:#b48ead>let </span><span style=color:#bf616a>msg </span><span>= </span><span style=color:#bf616a>msgInput</span><span>.value;
</span><span>
</span><span>      </span><span style=color:#b48ead>if </span><span>(</span><span style=color:#bf616a>msg </span><span>&& </span><span style=color:#bf616a>msg </span><span>!== '') {
</span><span>        </span><span style=color:#8fa1b3>stompClientSendMessage</span><span>(</span><span style=color:#bf616a>stompClient</span><span>, '</span><span style=color:#a3be8c>/app/message</span><span>', JSON.</span><span style=color:#96b5b4>stringify</span><span>({
</span><span>          toWhom: </span><span style=color:#bf616a>toWhom</span><span>,
</span><span>          fromWho: </span><span style=color:#bf616a>username</span><span>,
</span><span>          message: </span><span style=color:#bf616a>msg
</span><span>        }))
</span><span>        </span><span style=color:#b48ead>let </span><span style=color:#bf616a>messages </span><span>= </span><span style=color:#bf616a>chatRoom</span><span>.</span><span style=color:#96b5b4>querySelector</span><span>(`</span><span style=color:#a3be8c>#chat_messages_${</span><span style=color:#bf616a>toWhom</span><span style=color:#a3be8c>}</span><span>`);
</span><span>        </span><span style=color:#bf616a>messages</span><span>.</span><span style=color:#bf616a>innerHTML </span><span>+= `</span><span style=color:#a3be8c>&LTdiv class="row">&LTdiv class="col-md-1">Me:&LT/div>&LTdiv class="col-md-8">${</span><span style=color:#bf616a>msg</span><span style=color:#a3be8c>}&LT/div>&LT/div></span><span>`
</span><span>        </span><span style=color:#bf616a>msgInput</span><span>.value = ''
</span><span>      } </span><span style=color:#b48ead>else </span><span>{
</span><span>        </span><span style=color:#8fa1b3>alertMessage</span><span>(`</span><span style=color:#a3be8c>Message to user [${</span><span style=color:#bf616a>toWhom</span><span style=color:#a3be8c>}] cannot be empty !!!</span><span>`, "</span><span style=color:#a3be8c>bg-danger</span><span>")
</span><span>      }
</span><span>    }, </span><span style=color:#d08770>true</span><span>)
</span><span>  }
</span><span>  
</span><span>  </span><span style=color:#b48ead>function </span><span style=color:#8fa1b3>displayMessage</span><span>(</span><span style=color:#bf616a>chatList</span><span>, </span><span style=color:#bf616a>stompClient</span><span>, </span><span style=color:#bf616a>username</span><span>, {</span><span style=color:#bf616a>fromWho</span><span>, </span><span style=color:#bf616a>message</span><span>}){
</span><span>    </span><span style=color:#b48ead>let </span><span style=color:#bf616a>chatRoom </span><span>= </span><span style=color:#8fa1b3>getChat</span><span>(</span><span style=color:#bf616a>chatList</span><span>, </span><span style=color:#bf616a>fromWho</span><span>);
</span><span>    </span><span style=color:#b48ead>let </span><span style=color:#bf616a>messages </span><span>= </span><span style=color:#bf616a>chatRoom</span><span>.</span><span style=color:#96b5b4>querySelector</span><span>(`</span><span style=color:#a3be8c>#chat_messages_${</span><span style=color:#bf616a>fromWho</span><span style=color:#a3be8c>}</span><span>`);
</span><span>    </span><span style=color:#bf616a>messages</span><span>.</span><span style=color:#bf616a>innerHTML </span><span>+= `</span><span style=color:#a3be8c>&LTdiv class="row">&LTdiv class="col-md-1">${</span><span style=color:#bf616a>fromWho</span><span style=color:#a3be8c>}:&LT/div>&LTdiv class="col-md-8">${</span><span style=color:#bf616a>message</span><span style=color:#a3be8c>}&LT/div>&LT/div></span><span>`
</span><span>
</span><span>    </span><span style=color:#8fa1b3>clickSendButton</span><span>(</span><span style=color:#bf616a>chatRoom</span><span>, </span><span style=color:#bf616a>fromWho</span><span>, </span><span style=color:#bf616a>stompClient</span><span>, </span><span style=color:#bf616a>username</span><span>)
</span><span>
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#b48ead>function </span><span style=color:#8fa1b3>displayUserList</span><span>(</span><span style=color:#bf616a>userList</span><span>, </span><span style=color:#bf616a>chatList</span><span>, </span><span style=color:#bf616a>username</span><span>, </span><span style=color:#bf616a>stompClient</span><span>){
</span><span>    </span><span style=color:#b48ead>const </span><span style=color:#bf616a>lis </span><span>= </span><span style=color:#bf616a>userList</span><span>.length === </span><span style=color:#d08770>0 </span><span>? "</span><span style=color:#a3be8c>It looks like you are the only one in the chat room !!!</span><span>" : </span><span style=color:#bf616a>userList
</span><span>        .</span><span style=color:#8fa1b3>reduce</span><span>((</span><span style=color:#bf616a>acc</span><span>, </span><span style=color:#bf616a>item</span><span>) </span><span style=color:#b48ead>=> </span><span>`</span><span style=color:#a3be8c>${</span><span style=color:#bf616a>acc</span><span style=color:#a3be8c>}&LTli id="user_${</span><span style=color:#bf616a>item</span><span style=color:#a3be8c>}">&LTa href="#chat_${</span><span style=color:#bf616a>item</span><span style=color:#a3be8c>}">${</span><span style=color:#bf616a>item</span><span style=color:#a3be8c>}&LT/a>&LT/a>&LT/li></span><span>`, "")
</span><span>
</span><span>    </span><span style=color:#8fa1b3>select</span><span>("</span><span style=color:#a3be8c>#chat_user_list</span><span>").</span><span style=color:#bf616a>innerHTML </span><span>= `</span><span style=color:#a3be8c>&LTul>${</span><span style=color:#bf616a>lis</span><span style=color:#a3be8c>}&LT/ul></span><span>`
</span><span>
</span><span>    </span><span style=color:#bf616a>userList</span><span>.</span><span style=color:#96b5b4>forEach</span><span>(</span><span style=color:#bf616a>item </span><span style=color:#b48ead>=> </span><span style=color:#8fa1b3>select</span><span>(`</span><span style=color:#a3be8c>#chat_user_list #user_${</span><span style=color:#bf616a>item</span><span style=color:#a3be8c>}</span><span>`).</span><span style=color:#96b5b4>addEventListener</span><span>('</span><span style=color:#a3be8c>click</span><span>', () </span><span style=color:#b48ead>=> </span><span>{
</span><span>      </span><span style=color:#8fa1b3>clickSendButton</span><span>(</span><span style=color:#8fa1b3>getChat</span><span>(</span><span style=color:#bf616a>chatList</span><span>, </span><span style=color:#bf616a>item</span><span>), </span><span style=color:#bf616a>item</span><span>, </span><span style=color:#bf616a>stompClient</span><span>, </span><span style=color:#bf616a>username</span><span>);
</span><span>    }, </span><span style=color:#d08770>true</span><span>))
</span><span>  }
</span><span>  
</span><span>  </span><span style=color:#b48ead>function </span><span style=color:#8fa1b3>stompSubscribe</span><span>(</span><span style=color:#bf616a>stompClient</span><span>, </span><span style=color:#bf616a>endpoint</span><span>, </span><span style=color:#bf616a>callback</span><span>){ </span><span style=color:#65737e>//8
</span><span>    </span><span style=color:#bf616a>stompClient</span><span>.</span><span style=color:#8fa1b3>subscribe</span><span>(</span><span style=color:#bf616a>endpoint</span><span>, </span><span style=color:#bf616a>callback</span><span>)
</span><span>    </span><span style=color:#b48ead>return </span><span style=color:#bf616a>stompClient
</span><span>  }
</span><span>  
</span><span>  </span><span style=color:#b48ead>function </span><span style=color:#8fa1b3>stompClientSendMessage</span><span>(</span><span style=color:#bf616a>stompClient</span><span>, </span><span style=color:#bf616a>endpoint</span><span>, </span><span style=color:#bf616a>message</span><span>){ </span><span style=color:#65737e>// 9
</span><span>    </span><span style=color:#bf616a>stompClient</span><span>.</span><span style=color:#96b5b4>send</span><span>(</span><span style=color:#bf616a>endpoint</span><span>, {}, </span><span style=color:#bf616a>message</span><span>)
</span><span>    </span><span style=color:#b48ead>return </span><span style=color:#bf616a>stompClient
</span><span>  }
</span><span>  
</span><span>  </span><span style=color:#b48ead>function </span><span style=color:#8fa1b3>disconnect</span><span>(</span><span style=color:#bf616a>stompClient</span><span>, </span><span style=color:#bf616a>username</span><span>, </span><span style=color:#bf616a>connectBtn</span><span>, </span><span style=color:#bf616a>disconnectBtn</span><span>, </span><span style=color:#bf616a>clicked </span><span>= </span><span style=color:#d08770>false</span><span>){
</span><span>    </span><span style=color:#bf616a>connectBtn</span><span>.disabled = </span><span style=color:#d08770>false
</span><span>    </span><span style=color:#bf616a>disconnectBtn</span><span>.disabled = </span><span style=color:#d08770>true
</span><span>    </span><span style=color:#b48ead>if</span><span>(</span><span style=color:#bf616a>clicked</span><span>){
</span><span>      </span><span style=color:#8fa1b3>stompClientSendMessage</span><span>(</span><span style=color:#bf616a>stompClient</span><span>, '</span><span style=color:#a3be8c>/app/unregister</span><span>', </span><span style=color:#bf616a>username</span><span>)
</span><span>    }
</span><span>    </span><span style=color:#bf616a>stompClient</span><span>.</span><span style=color:#96b5b4>disconnect</span><span>() </span><span style=color:#65737e>//6-1
</span><span>  }
</span><span>  
</span><span>  </span><span style=color:#b48ead>function </span><span style=color:#8fa1b3>connect</span><span>(</span><span style=color:#bf616a>username</span><span>){ </span><span style=color:#65737e>//1-1
</span><span>    </span><span style=color:#b48ead>return </span><span>new Promise((</span><span style=color:#bf616a>resolve</span><span>, </span><span style=color:#bf616a>reject</span><span>) </span><span style=color:#b48ead>=> </span><span>{
</span><span>      </span><span style=color:#b48ead>let </span><span style=color:#bf616a>stompClient </span><span>= </span><span style=color:#bf616a>Stomp</span><span>.</span><span style=color:#8fa1b3>over</span><span>(new SockJS('</span><span style=color:#a3be8c>/websocket-chat</span><span>'))
</span><span>      </span><span style=color:#bf616a>stompClient</span><span>.</span><span style=color:#8fa1b3>connect</span><span>({}, (</span><span style=color:#bf616a>frame</span><span>) </span><span style=color:#b48ead>=> </span><span style=color:#8fa1b3>resolve</span><span>(</span><span style=color:#bf616a>stompClient</span><span>))
</span><span>    })
</span><span>  }
</span><span>  
</span><span>  </span><span style=color:#65737e>//To guarantee that our page is completely loaded before we execute anything
</span><span>  window.</span><span style=color:#96b5b4>addEventListener</span><span>('</span><span style=color:#a3be8c>load</span><span>', </span><span style=color:#b48ead>function</span><span>(</span><span style=color:#bf616a>event</span><span>){
</span><span>    </span><span style=color:#b48ead>let </span><span style=color:#bf616a>chatUsersList </span><span>= [];
</span><span>    </span><span style=color:#b48ead>let </span><span style=color:#bf616a>chatList </span><span>= </span><span style=color:#8fa1b3>select</span><span>("</span><span style=color:#a3be8c>#chat_list</span><span>");
</span><span>    </span><span style=color:#b48ead>let </span><span style=color:#bf616a>connectButton </span><span>= </span><span style=color:#8fa1b3>select</span><span>("</span><span style=color:#a3be8c>#webchat_connect</span><span>");
</span><span>    </span><span style=color:#b48ead>let </span><span style=color:#bf616a>disconnectButton </span><span>= </span><span style=color:#8fa1b3>select</span><span>("</span><span style=color:#a3be8c>#webchat_disconnect</span><span>");
</span><span>
</span><span>    </span><span style=color:#bf616a>connectButton</span><span>.</span><span style=color:#96b5b4>addEventListener</span><span>('</span><span style=color:#a3be8c>click</span><span>', () </span><span style=color:#b48ead>=> </span><span>{
</span><span>      </span><span style=color:#b48ead>let </span><span style=color:#bf616a>username </span><span>= </span><span style=color:#8fa1b3>select</span><span>("</span><span style=color:#a3be8c>#webchat_username</span><span>").value;
</span><span>
</span><span>      </span><span style=color:#b48ead>if</span><span>(</span><span style=color:#bf616a>username </span><span>== </span><span style=color:#d08770>null </span><span>|| </span><span style=color:#bf616a>username </span><span>=== ''){
</span><span>        </span><span style=color:#8fa1b3>alertMessage</span><span>('</span><span style=color:#a3be8c>Name cannot be empty!!!</span><span>', '</span><span style=color:#a3be8c>bg-danger</span><span>')
</span><span>      } </span><span style=color:#b48ead>else </span><span>{
</span><span>        </span><span style=color:#8fa1b3>connect</span><span>(</span><span style=color:#bf616a>username</span><span>) </span><span style=color:#65737e>//1
</span><span>            .</span><span style=color:#96b5b4>then</span><span>((</span><span style=color:#bf616a>stompClient</span><span>) </span><span style=color:#b48ead>=> </span><span style=color:#8fa1b3>stompSubscribe</span><span>(</span><span style=color:#bf616a>stompClient</span><span>, '</span><span style=color:#a3be8c>/user/queue/newMember</span><span>', (</span><span style=color:#bf616a>data</span><span>) </span><span style=color:#b48ead>=> </span><span>{ </span><span style=color:#65737e>//2
</span><span>              </span><span style=color:#bf616a>chatUsersList </span><span>= JSON.</span><span style=color:#96b5b4>parse</span><span>(</span><span style=color:#bf616a>data</span><span>.body)
</span><span>              </span><span style=color:#b48ead>if</span><span>(</span><span style=color:#bf616a>chatUsersList</span><span>.length > </span><span style=color:#d08770>0</span><span>){
</span><span>                </span><span style=color:#8fa1b3>displayUserList</span><span>(</span><span style=color:#bf616a>chatUsersList</span><span>.</span><span style=color:#8fa1b3>filter</span><span>(</span><span style=color:#bf616a>x </span><span style=color:#b48ead>=> </span><span style=color:#bf616a>x </span><span>!= </span><span style=color:#bf616a>username</span><span>), </span><span style=color:#bf616a>chatList</span><span>, </span><span style=color:#bf616a>username</span><span>, </span><span style=color:#bf616a>stompClient</span><span>)
</span><span>              } </span><span style=color:#b48ead>else </span><span>{
</span><span>                </span><span style=color:#8fa1b3>alertMessage</span><span>("</span><span style=color:#a3be8c>Username already exists!!!</span><span>", "</span><span style=color:#a3be8c>bg-danger</span><span>")
</span><span>                </span><span style=color:#8fa1b3>disconnect</span><span>(</span><span style=color:#bf616a>stompClient</span><span>, </span><span style=color:#bf616a>username</span><span>, </span><span style=color:#bf616a>connectButton</span><span>, </span><span style=color:#bf616a>disconnectButton</span><span>)
</span><span>              }
</span><span>            })).</span><span style=color:#96b5b4>then</span><span>((</span><span style=color:#bf616a>stompClient</span><span>) </span><span style=color:#b48ead>=> </span><span style=color:#8fa1b3>stompSubscribe</span><span>(</span><span style=color:#bf616a>stompClient</span><span>, '</span><span style=color:#a3be8c>/topic/newMember</span><span>', (</span><span style=color:#bf616a>data</span><span>) </span><span style=color:#b48ead>=> </span><span>{  </span><span style=color:#65737e>// 3
</span><span>              </span><span style=color:#bf616a>chatUsersList</span><span>.</span><span style=color:#96b5b4>push</span><span>(</span><span style=color:#bf616a>data</span><span>.body);
</span><span>              </span><span style=color:#8fa1b3>displayUserList</span><span>(</span><span style=color:#bf616a>chatUsersList</span><span>.</span><span style=color:#8fa1b3>filter</span><span>(</span><span style=color:#bf616a>x </span><span style=color:#b48ead>=> </span><span style=color:#bf616a>x </span><span>!= </span><span style=color:#bf616a>username</span><span>), </span><span style=color:#bf616a>chatList</span><span>, </span><span style=color:#bf616a>username</span><span>, </span><span style=color:#bf616a>stompClient</span><span>)
</span><span>            })).</span><span style=color:#96b5b4>then</span><span>((</span><span style=color:#bf616a>stompClient</span><span>) </span><span style=color:#b48ead>=> </span><span style=color:#8fa1b3>stompClientSendMessage</span><span>(</span><span style=color:#bf616a>stompClient</span><span>, '</span><span style=color:#a3be8c>/app/register</span><span>', </span><span style=color:#bf616a>username</span><span>)) </span><span style=color:#65737e>// 4
</span><span>            .</span><span style=color:#96b5b4>then</span><span>((</span><span style=color:#bf616a>stompClient</span><span>) </span><span style=color:#b48ead>=> </span><span style=color:#8fa1b3>stompSubscribe</span><span>(</span><span style=color:#bf616a>stompClient</span><span>, `</span><span style=color:#a3be8c>/user/${</span><span style=color:#bf616a>username</span><span style=color:#a3be8c>}/msg</span><span>`, (</span><span style=color:#bf616a>data</span><span>) </span><span style=color:#b48ead>=> </span><span>{
</span><span>              </span><span style=color:#8fa1b3>displayMessage</span><span>(</span><span style=color:#bf616a>chatList</span><span>, </span><span style=color:#bf616a>stompClient</span><span>, </span><span style=color:#bf616a>username</span><span>, JSON.</span><span style=color:#96b5b4>parse</span><span>(</span><span style=color:#bf616a>data</span><span>.body))
</span><span>            }))
</span><span>            .</span><span style=color:#96b5b4>then</span><span>((</span><span style=color:#bf616a>stompClient</span><span>) </span><span style=color:#b48ead>=> </span><span>{ </span><span style=color:#65737e>//5
</span><span>              </span><span style=color:#bf616a>connectButton</span><span>.disabled = </span><span style=color:#d08770>true</span><span>;
</span><span>              </span><span style=color:#bf616a>disconnectButton</span><span>.disabled = </span><span style=color:#d08770>false</span><span>;
</span><span>              </span><span style=color:#bf616a>disconnectButton</span><span>.</span><span style=color:#96b5b4>addEventListener</span><span>('</span><span style=color:#a3be8c>click</span><span>', () </span><span style=color:#b48ead>=> </span><span style=color:#8fa1b3>disconnect</span><span>(</span><span style=color:#bf616a>stompClient</span><span>, </span><span style=color:#bf616a>username</span><span>, </span><span style=color:#bf616a>connectButton</span><span>, </span><span style=color:#bf616a>disconnectButton</span><span>, </span><span style=color:#d08770>true</span><span>), </span><span style=color:#d08770>true</span><span>); </span><span style=color:#65737e>// 6
</span><span>              </span><span style=color:#b48ead>return </span><span style=color:#bf616a>stompClient</span><span>;
</span><span>            }).</span><span style=color:#96b5b4>then</span><span>((</span><span style=color:#bf616a>stompClient</span><span>) </span><span style=color:#b48ead>=> </span><span style=color:#8fa1b3>stompSubscribe</span><span>(</span><span style=color:#bf616a>stompClient</span><span>, '</span><span style=color:#a3be8c>/topic/disconnectedUser</span><span>', (</span><span style=color:#bf616a>data</span><span>) </span><span style=color:#b48ead>=> </span><span>{ </span><span style=color:#65737e>// 7
</span><span>              </span><span style=color:#b48ead>const </span><span style=color:#bf616a>userWhoLeft </span><span>= </span><span style=color:#bf616a>data</span><span>.body;
</span><span>              </span><span style=color:#bf616a>chatUsersList </span><span>= </span><span style=color:#bf616a>chatUsersList</span><span>.</span><span style=color:#8fa1b3>filter</span><span>(</span><span style=color:#bf616a>x </span><span style=color:#b48ead>=> </span><span style=color:#bf616a>x </span><span>!= </span><span style=color:#bf616a>userWhoLeft</span><span>);
</span><span>              </span><span style=color:#8fa1b3>displayUserList</span><span>(</span><span style=color:#bf616a>chatUsersList</span><span>.</span><span style=color:#8fa1b3>filter</span><span>(</span><span style=color:#bf616a>x </span><span style=color:#b48ead>=> </span><span style=color:#bf616a>x </span><span>!= </span><span style=color:#bf616a>username</span><span>), </span><span style=color:#bf616a>chatList</span><span>, </span><span style=color:#bf616a>username</span><span>, </span><span style=color:#bf616a>stompClient</span><span>);
</span><span>              </span><span style=color:#8fa1b3>alertMessage</span><span>(`</span><span style=color:#a3be8c>User [${</span><span style=color:#bf616a>userWhoLeft</span><span style=color:#a3be8c>}] left the chat room!!!</span><span>`, "</span><span style=color:#a3be8c>bg-success</span><span>")
</span><span>            }))
</span><span>      }
</span><span>      }, </span><span style=color:#d08770>true</span><span>)
</span><span>  });
</span><span>})();
</span></code></pre><p>Como previamente dito, não irei explicar detalhes de JS aqui, irei focar somente nas coisas de WebSocket, mas se você não entender onde começa não irá entender nada por aqui, logo nosso ponto de partida de tudo é <code>window.addEventListener('load', function(event)</code>. Tudo acima disso é apenas declaração de funções. Então agora irei fazer o mesmo que fiz antes e colocar comentários mostrando coisas importantes usando números:<ol><li>Vamos do começo. Depois de checar se o nome do usuário é ou não válido nós conectamos em nosso WebSocket, se você olhar a função <code>connect</code> verá que é muito simples. Apenas passe a url do nosso servidor de WebSocket, aquela que configuramos na classe Java WebSocketConmfig: <code>/websocket-chat</code>.<li>Agora iremos começar nos inscrevendo aos endpoints nos possiblitando receber mensagens. O primeiro endpoint que iremos nos inscrever é o newMember para sabermos se estamos registrados ou não. Lembra que eu disse que não é automático e devemos enviar uma mensagem para nos registrar? Pois então, antes de enviarmos a mensagem precisamos nos inscrever para o 'retorno' do endpoint, caso contrário a mensagem será enviada em um momento que não estaremos ouvindo. Outro ponto aqui, se olhar na função Java eu retorno uma lista vazia se o usuário já existir. Isso é apenas eu dizendo: 'Seu usuário já existe, tente outro'. Você pode fazer diferente, você pode criar uma classe que represente falha e sucesso por exemplo, mas o que você não pode é retornar 'null'. Eu tentei, não funciona, o servidor não manda a mensagem.<li>Para que possamos continuar recebendo alertas quando outros usuários connectam nós nos inscrevemos na versão <code>/topic</code> do endpoint acima. Se você lembrar, o endpoint <code>/queue/newMember</code> irá nos retornar uma lista com todos os usuários conectados e o <code>/topic</code> somente o nome de quem se conectou. Outra diferença é que por usarmos <code>/queue</code> nós somente receberemos uma única vez a lista completa de usuário e para nos mantermos atualizados precisamos do <code>/topic</code>. Você pode notar que eu não checo quando nos conectamos para ignorar nosso nome, sinta- se livre para corrigir esse erro ^^<li>Agora que nos inscrevemos no enpoint que irá nos dizer se estamos registrados na sala de chat ou não, podemos finalmente nos reigstrar. Então iremos enviar uma mensagem para <code>/app/register</code> e nos registrar.<li>Aqui eu desabilito o botão de conectar para que você não reconecte acidentalmente e habilito o botão de desconectar.<li>Aqui estou a adicionar a função de nos disconectar quando clicamos no botão de disconectar.<li>Aqui é uma simples reação a quando alguém deixa o chat.<li>Aqui você pode ver quão simples é se inscrever em um endpoint, você só precisa chamar o método <code>subscribe</code> do StompClient e pssar o endpoint que você quer se inscrever e o callback para reagir a suas mensagens.<li>Aqui o mesmo para você ver o quão simples é enviar uma mensagem para um endpoint. Apenas chame o método <code>send</code>do StompClient e passe o endpoint e a mensagem em si. Cheque se a mensagem precisa ser convertidade antes de ser enviada, como JSON.stringify ou qualquer outra coisa.</ol><p>O resto é apenas eu tentando facilitar para você adaptar isso para quaisquer que seja sua necessidade. Execute e sinta-se livre para me xingar ou me cumprimentar quando eu adicionar comentários ao blog. Se quiser ver o código fonte por favor vá até esta <a href=https://github.com/kiberStender/spring_websocket_webchat>URL</a>.<p>Muitíssimo obrigado por seu tempo, espero ter ajudado de alguma forma, até mais.</section></article></main></div>